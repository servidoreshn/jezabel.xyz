<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FILE NAVIGATOR</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Courier New', Courier, monospace;
            background: #000000;
            color: #cc0033;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.4s ease, color 0.4s ease;
            animation: rgbPulse 8s ease-in-out infinite;
        }
        
        @keyframes rgbPulse {
            0%, 100% { background: #000000; }
            33% { background: #000505; filter: hue-rotate(10deg); }
            66% { background: #050005; filter: hue-rotate(-10deg); }
        }
        
        body.light-mode { 
            background: #ffffff; 
            color: #000000; 
            animation: none; /* Disable RGB pulse */
        }
        body.light-mode .terminal-header { 
            border-color: #8b0000; 
            background: rgba(255, 255, 255, 0.95); 
            box-shadow: 0 0 20px rgba(139, 0, 0, 0.2);
            animation: none; /* Disable border RGB */
        }
        body.light-mode .path-display { 
            color: #8b0000; 
            text-shadow: none;
            animation: none; /* Disable title chaos */
        }
        body.light-mode .terminal-prompt { color: #333; text-shadow: none; }
        body.light-mode .path-display .current-folder { color: #a52a2a; }
        body.light-mode .cursor { background: #8b0000; }
        body.light-mode .file-item { 
            border-color: #8b0000; 
            background: rgba(255, 255, 255, 0.9);
            animation: none; /* Disable item pulse */
        }
        body.light-mode .file-item:hover { box-shadow: 0 10px 30px rgba(139, 0, 0, 0.3); border-color: #a52a2a; }
        body.light-mode .file-name { color: #000000; }
        body.light-mode .file-item.folder .file-name { color: #8b0000; }
        body.light-mode .control-btn { background: rgba(255, 255, 255, 0.9); border-color: #8b0000; color: #8b0000; }
        body.light-mode .control-btn:hover { background: rgba(139, 0, 0, 0.1); }
        body.light-mode .control-btn.active { background: #8b0000; color: #ffffff; }
        body.light-mode .control-bar { background: rgba(139, 0, 0, 0.05); border-color: #8b0000; }
        body.light-mode .matrix-rain { opacity: 0.03; }
        body.light-mode .mode-toggle { background: rgba(139, 0, 0, 0.1); border-color: #8b0000; color: #8b0000; }
        body.light-mode .loading { color: #8b0000; }
        body.light-mode .loading-spinner { border-top-color: #8b0000; }
        body.light-mode .error { background: rgba(204, 0, 51, 0.1); border-color: #cc0033; color: #cc0033; }
        body.light-mode .breadcrumb-item { color: #8b0000; }
        body.light-mode .breadcrumb-item:hover { color: #a52a2a; border-color: #a52a2a; background: rgba(165, 42, 42, 0.1); }
        body.light-mode .file-item.audio .file-name { color: #6a0dad; }
        body.light-mode .file-item.video .file-name { color: #cc0044; }
        body.light-mode .file-item.image .file-name { color: #006400; }
        body.light-mode .file-item.document .file-name { color: #b8860b; }
        body.light-mode .file-item.code .file-name { color: #4b0082; }
        body.light-mode .file-item.archive .file-name { color: #8b4513; }
        
        .matrix-rain { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; overflow: hidden; opacity: 0.6; }
        .matrix-column { position: absolute; top: -100%; font-size: 14px; white-space: nowrap; animation: matrixFall linear infinite; color: #00ff00; }
        @keyframes matrixFall { to { top: 100%; } }
        
        .file-container { position: relative; z-index: 10; max-width: 1400px; margin: 0 auto; padding: 40px 30px; min-height: 100vh; }
        .terminal-header { 
            border: 2px solid #cc0033; 
            background: rgba(20, 0, 10, 0.95); 
            padding: 20px 25px; 
            margin-bottom: 30px; 
            box-shadow: 0 0 30px rgba(204, 0, 51, 0.4);
            animation: borderRGB 6s linear infinite;
        }
        
        @keyframes borderRGB {
            0% { 
                border-color: #cc0033;
                box-shadow: 0 0 30px rgba(204, 0, 51, 0.4);
            }
            33% { 
                border-color: #9d00ff;
                box-shadow: 0 0 30px rgba(157, 0, 255, 0.4);
            }
            66% { 
                border-color: #ff0066;
                box-shadow: 0 0 30px rgba(255, 0, 102, 0.4);
            }
            100% { 
                border-color: #cc0033;
                box-shadow: 0 0 30px rgba(204, 0, 51, 0.4);
            }
        }
        .path-display { 
            font-size: 18px; 
            letter-spacing: 2px; 
            color: #ff0066; 
            margin-bottom: 10px; 
            text-shadow: 0 0 10px rgba(255, 0, 102, 0.5);
            animation: titleChaos 0.3s infinite;
        }
        
        @keyframes titleChaos {
            0%, 100% { 
                text-shadow: 2px 0 #ff0066, -2px 0 #9d00ff;
                transform: translate(0);
            }
            50% { 
                text-shadow: 2px 0 #cc0033, -2px 0 #ff0066;
                transform: translate(1px, -1px);
            }
        }
        
        .path-display .current-folder { color: #9d00ff; font-weight: bold; }
        .terminal-prompt { font-size: 12px; color: #cc0033; margin-top: 10px; }
        .cursor { display: inline-block; width: 8px; height: 14px; background: #ff0066; animation: cursorBlink 1s infinite; margin-left: 5px; }
        @keyframes cursorBlink { 0%, 49% { opacity: 1; } 50%, 100% { opacity: 0; } }
        
        .breadcrumb { display: flex; align-items: center; flex-wrap: wrap; gap: 5px; margin-top: 10px; font-size: 11px; }
        .breadcrumb-item { color: #9d00ff; cursor: pointer; transition: all 0.3s; padding: 3px 8px; border: 1px solid transparent; }
        .breadcrumb-item:hover { color: #ff0066; border-color: #ff0066; background: rgba(255, 0, 102, 0.1); }
        .breadcrumb-separator { color: #666; }
        
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .file-item { 
            border: 2px solid #cc0033; 
            background: rgba(20, 0, 10, 0.9); 
            padding: 15px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            text-decoration: none; 
            display: block; 
            color: inherit;
            animation: itemPulse 4s ease-in-out infinite;
        }
        
        @keyframes itemPulse {
            0%, 100% { border-color: #cc0033; }
            50% { border-color: #ff0066; }
        }
        
        .file-item:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 30px rgba(204, 0, 51, 0.4); 
            border-color: #9d00ff;
        }
        .file-item.folder { border-color: #9d00ff; }
        .file-item.folder:hover { border-color: #ff0066; }
        .file-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .file-icon { font-size: 24px; flex-shrink: 0; }
        .file-name { font-size: 13px; color: #ff0066; word-break: break-all; flex: 1; }
        .file-item.folder .file-name { color: #9d00ff; font-weight: bold; }
        .file-meta { font-size: 10px; color: #666; margin-top: 8px; padding-top: 8px; border-top: 1px solid #222; }
        .meta-value { color: #cc0033; }
        .meta-value { color: #00ff00; }
        
        .file-item.audio .file-name { color: #00d4ff; }
        .file-item.video .file-name { color: #ff0066; }
        .file-item.image .file-name { color: #00ff00; }
        .file-item.document .file-name { color: #ffaa00; }
        .file-item.code .file-name { color: #9d00ff; }
        .file-item.archive .file-name { color: #cc0033; }
        
        .loading { text-align: center; padding: 40px; color: #ff0066; font-size: 14px; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid #333; border-top-color: #ff0066; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .error { background: rgba(255, 0, 0, 0.1); border: 2px solid #ff0000; padding: 20px; color: #ff0000; font-size: 12px; line-height: 1.6; }
        .control-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px 15px; background: rgba(204, 0, 51, 0.05); border: 1px solid #cc0033; }
        .control-group { display: flex; gap: 10px; align-items: center; }
        .control-label { font-size: 11px; color: #888; }
        .control-btn { padding: 5px 12px; font-size: 10px; background: rgba(20, 0, 10, 0.8); border: 1px solid #cc0033; color: #cc0033; cursor: pointer; font-family: 'Courier New', monospace; transition: all 0.3s; }
        .control-btn:hover { background: rgba(204, 0, 51, 0.2); box-shadow: 0 0 10px rgba(204, 0, 51, 0.3); }
        .control-btn.active { background: #cc0033; color: #000; }
        
        .mode-toggle { position: fixed; top: 20px; right: 20px; background: rgba(204, 0, 51, 0.2); border: 2px solid #cc0033; color: #ff0066; padding: 8px 15px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; z-index: 1000; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .mode-toggle:hover { background: rgba(204, 0, 51, 0.4); transform: translateY(-2px); }
        .mode-icon { font-size: 16px; }
        .mode-time { font-size: 9px; opacity: 0.7; }
        
        @media (max-width: 768px) {
            .file-container { padding: 20px 15px; }
            .file-grid { grid-template-columns: 1fr; }
            .control-bar { flex-direction: column; gap: 10px; }
            .path-display { font-size: 14px; }
            .mode-toggle { top: 10px; right: 10px; font-size: 9px; padding: 6px 10px; }
        }
    </style>
</head>
<body>
    <div class="matrix-rain"></div>
    
    <button class="mode-toggle" onclick="toggleMode()" id="modeToggle">
        <span class="mode-icon">üåô</span>
        <span>DARK</span>
        <span class="mode-time" id="modeTime"></span>
    </button>
    
    <div class="file-container">
        <div class="terminal-header">
            <div class="path-display">üìÅ <span class="current-folder" id="currentPath">./</span></div>
            <div class="terminal-prompt">root@navigator:~$ ls -lah <span id="promptPath">./</span><span class="cursor"></span></div>
            <div class="breadcrumb" id="breadcrumb"></div>
        </div>
        
        <div class="control-bar">
            <div class="control-group">
                <span class="control-label">SORT:</span>
                <button class="control-btn active" onclick="sortFiles('name')">NAME</button>
                <button class="control-btn" onclick="sortFiles('type')">TYPE</button>
            </div>
            <div class="control-group">
                <span class="control-label">VIEW:</span>
                <button class="control-btn" onclick="toggleHidden()">SHOW HIDDEN</button>
                <button class="control-btn" onclick="refreshFiles()">‚Üª REFRESH</button>
            </div>
        </div>
        
        <div id="fileListContainer">
            <div class="loading"><span class="loading-spinner"></span>Scanning filesystem...</div>
        </div>
    </div>
    
    <script>
        let showHidden = false;
        let sortBy = 'name';
        
        const FILE_TYPES = {
            audio: ['mp3', 'wav', 'flac', 'aac', 'ogg', 'm4a', 'wma'], 
            video: ['mp4', 'avi', 'mkv', 'mov', 'wmv', 'webm', 'flv'],
            image: ['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp', 'bmp', 'ico'], 
            document: ['pdf', 'doc', 'docx', 'txt', 'md', 'rtf', 'odt'],
            code: ['js', 'py', 'html', 'css', 'java', 'json', 'sh', 'xml', 'yml', 'cpp', 'c', 'go', 'rs'], 
            archive: ['zip', 'rar', '7z', 'tar', 'gz', 'bz2', 'xz']
        };
        
        const FILE_ICONS = { 
            folder: 'üìÅ', audio: 'üéµ', video: 'üé¨', image: 'üñºÔ∏è', 
            document: 'üìÑ', code: '‚öôÔ∏è', archive: 'üì¶', default: 'üìÑ' 
        };
        
        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            for (const [type, extensions] of Object.entries(FILE_TYPES)) 
                if (extensions.includes(ext)) return type;
            return 'default';
        }
        
        function getCurrentDirName() {
            const fullPath = decodeURIComponent(window.location.pathname);
            const parts = fullPath.split('/').filter(p => p);
            return parts.length > 0 ? parts[parts.length - 1] : 'Documents';
        }
        
        async function fetchFileList() {
            // Fetch autoindex from special endpoint
            const autoindexUrl = window.location.pathname.endsWith('/') 
                ? window.location.pathname + '__autoindex'
                : window.location.pathname + '/__autoindex';
            
            try {
                const response = await fetch(autoindexUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Check for nginx autoindex
                const h1 = doc.querySelector('h1');
                if (!h1 || !h1.textContent.includes('Index of')) {
                    throw new Error('AUTOINDEX_NOT_FOUND');
                }
                
                const items = [];
                const pre = doc.querySelector('pre');
                
                if (!pre) {
                    throw new Error('NO_LISTING');
                }
                
                const links = pre.querySelectorAll('a');
                
                links.forEach((link) => {
                    const href = link.getAttribute('href');
                    const text = link.textContent.trim();
                    
                    // Skip sort links
                    if (!href || href.startsWith('?C=')) return;
                    
                    // Parent directory
                    if (href === '../') {
                        items.push({ name: '..', type: 'folder', size: 0, isParent: true, href: href });
                        return;
                    }
                    
                    const isFolder = href.endsWith('/');
                    const name = decodeURIComponent(text.replace(/\/$/, ''));
                    
                    if (!name) return;
                    
                    // Parse size from nginx format
                    let size = 0;
                    const nextText = link.nextSibling;
                    if (nextText && nextText.nodeType === Node.TEXT_NODE) {
                        const parts = nextText.textContent.trim().split(/\s+/);
                        if (parts.length >= 3 && !isFolder) {
                            size = parts[parts.length - 1];
                        }
                    }
                    
                    items.push({ name: name, type: isFolder ? 'folder' : 'file', size: size, isParent: false, href: href });
                });
                
                return items;
                
            } catch (error) {
                throw error;
            }
        }
        
        function renderFiles(items) {
            const container = document.getElementById('fileListContainer');
            let filtered = items.filter(i => showHidden || !i.name.startsWith('.') || i.isParent);
            
            filtered.sort((a, b) => {
                if (a.type === 'folder' && b.type !== 'folder') return -1;
                if (a.type !== 'folder' && b.type === 'folder') return 1;
                if (a.isParent) return -1;
                if (b.isParent) return 1;
                if (sortBy === 'type') return getFileType(a.name).localeCompare(getFileType(b.name));
                return a.name.localeCompare(b.name);
            });
            
            if (filtered.length === 0 || (filtered.length === 1 && filtered[0].isParent)) {
                container.innerHTML = '<div style="text-align: center; padding: 60px; color: #666;">üìÇ Empty directory</div>';
                return;
            }
            
            const html = filtered.map(item => {
                const isFolder = item.type === 'folder';
                const fileType = isFolder ? 'folder' : getFileType(item.name);
                const icon = FILE_ICONS[fileType] || FILE_ICONS.default;
                
                return `<a href="${item.href}" class="file-item ${fileType}">
                    <div class="file-header"><div class="file-icon">${icon}</div><div class="file-name">${item.name}</div></div>
                    ${!item.isParent ? `<div class="file-meta"><div class="meta-row"><span style="color: #888;">TYPE</span><span class="meta-value">${fileType.toUpperCase()}</span></div>
                    ${!isFolder && item.size !== '-' ? `<div class="meta-row"><span style="color: #888;">SIZE</span><span class="meta-value">${item.size}</span></div>` : ''}</div>` : ''}
                </a>`;
            }).join('');
            
            container.innerHTML = `<div class="file-grid">${html}</div>`;
        }
        
        async function loadFiles() {
            const container = document.getElementById('fileListContainer');
            container.innerHTML = '<div class="loading"><span class="loading-spinner"></span>Loading...</div>';
            
            try {
                const items = await fetchFileList();
                renderFiles(items);
                updatePathDisplay();
            } catch (error) {
                if (error.message === 'AUTOINDEX_NOT_FOUND') {
                    container.innerHTML = `<div class="error">‚ùå <strong>Nginx autoindex not enabled</strong><br><br>
                        This file needs autoindex to work.<br><br>
                        Your nginx config looks correct. Make sure:<br>
                        1. You reload nginx: <code>nginx -s reload</code><br>
                        2. Remove or rename this index.html temporarily to see raw autoindex<br>
                        3. Then put it back</div>`;
                } else if (error.message === 'NO_LISTING') {
                    container.innerHTML = `<div class="error">‚ùå Cannot read directory listing</div>`;
                } else {
                    container.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                }
            }
        }
        
        function updatePathDisplay() {
            const dirName = getCurrentDirName();
            document.getElementById('currentPath').textContent = dirName + '/';
            document.getElementById('promptPath').textContent = './';
            document.title = `${dirName} - FILE NAVIGATOR`;
            document.getElementById('breadcrumb').innerHTML = `<span class="breadcrumb-item">${dirName}</span>`;
        }
        
        function sortFiles(by) { 
            sortBy = by; 
            document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active')); 
            event.target.classList.add('active'); 
            loadFiles(); 
        }
        
        function toggleHidden() { 
            showHidden = !showHidden; 
            event.target.textContent = showHidden ? 'HIDE HIDDEN' : 'SHOW HIDDEN'; 
            loadFiles(); 
        }
        
        function refreshFiles() { loadFiles(); }
        
        let manualModeOverride = false;
        
        function toggleMode() {
            manualModeOverride = true;
            document.body.classList.toggle('light-mode');
            updateModeButton();
            localStorage.setItem('manualMode', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        }
        
        function setAutomaticMode() {
            const hour = new Date().getHours();
            const shouldBeLight = hour >= 6 && hour < 18;
            const isLightMode = document.body.classList.contains('light-mode');
            if (shouldBeLight && !isLightMode) { 
                document.body.classList.add('light-mode'); 
                updateModeButton(); 
            } else if (!shouldBeLight && isLightMode) { 
                document.body.classList.remove('light-mode'); 
                updateModeButton(); 
            }
        }
        
        function updateModeButton() {
            const toggle = document.getElementById('modeToggle');
            const isLight = document.body.classList.contains('light-mode');
            const timeStr = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
            toggle.querySelector('.mode-icon').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
            toggle.querySelector('span:nth-child(2)').textContent = isLight ? 'LIGHT' : 'DARK';
            document.getElementById('modeTime').textContent = manualModeOverride ? 'MANUAL' : timeStr;
        }
        
        function initializeMode() {
            const savedMode = localStorage.getItem('manualMode');
            if (savedMode) { 
                manualModeOverride = true; 
                if (savedMode === 'light') document.body.classList.add('light-mode'); 
            } else setAutomaticMode();
            updateModeButton();
            setInterval(() => { 
                if (!manualModeOverride) setAutomaticMode(); 
                updateModeButton(); 
            }, 60000);
        }
        
        function createMatrixRain() {
            const container = document.querySelector('.matrix-rain');
            const chars = '01ŒõŒ£ŒòŒûŒ®‚ñì‚ñí‚ñë‚ñà{}[]<>/\\|';
            const colors = ['#00ff00', '#00d4ff', '#ff0066', '#9d00ff', '#ffaa00'];
            
            for (let i = 0; i < 80; i++) {
                const col = document.createElement('div');
                col.className = 'matrix-column';
                col.style.left = Math.random() * 100 + '%';
                col.style.animationDuration = (Math.random() * 4 + 3) + 's';
                col.style.animationDelay = Math.random() * 5 + 's';
                col.style.fontSize = (Math.random() * 6 + 12) + 'px';
                
                // Random RGB color
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                col.style.color = randomColor;
                col.style.textShadow = `0 0 10px ${randomColor}`;
                
                let text = '';
                const length = Math.floor(Math.random() * 25) + 15;
                for (let j = 0; j < length; j++) {
                    text += chars[Math.floor(Math.random() * chars.length)] + '\n';
                }
                col.textContent = text;
                
                container.appendChild(col);
                
                // Random color change glitching
                setInterval(() => {
                    if (Math.random() > 0.7) {
                        const newColor = colors[Math.floor(Math.random() * colors.length)];
                        col.style.color = newColor;
                        col.style.textShadow = `0 0 10px ${newColor}`;
                    }
                }, Math.random() * 2000 + 1000);
            }
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'r' && e.ctrlKey) { e.preventDefault(); refreshFiles(); }
            if (e.key === 't' && e.ctrlKey) { e.preventDefault(); toggleMode(); }
        });
        
        window.addEventListener('load', () => { 
            createMatrixRain(); 
            initializeMode(); 
            loadFiles(); 
        });
    </script>
</body>
</html>
